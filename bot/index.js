import { Telegraf } from 'telegraf';
import { config } from './config.js';
import { handleStart, handleMessage, handleLogout, getUserState } from './handlers/auth.js';
import {
  handleGoodsList,
  handleGoodsMenu,
  handleCreateGood,
  handleUpdateGood,
  handleDeleteGood,
  handleIncome,
  handleExpense,
  handleGoodState,
} from './handlers/goods.js';
import { showMainMenu } from './keyboards/menu.js';

const bot = new Telegraf(config.telegram.token);

// ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹ /start
bot.command('start', handleStart);

// ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹ /logout
bot.command('logout', handleLogout);

// ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° Ñ‚ÐµÐºÑÑ‚Ð¾Ð²Ñ‹Ñ… ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¹
bot.on('text', async (ctx) => {
  const userId = ctx.from.id;
  const state = getUserState(userId);
  const text = ctx.message.text;
  
  // ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, Ð½Ð°Ñ…Ð¾Ð´Ð¸Ñ‚ÑÑ Ð»Ð¸ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ Ð² Ð¿Ñ€Ð¾Ñ†ÐµÑÑÐµ ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ñ/Ñ€ÐµÐ´Ð°ÐºÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ
  if (state.step && (
      state.step.startsWith('creating_') || 
      state.step.startsWith('updating_') ||
      state.step.startsWith('deleting_') ||
      state.step.startsWith('income_') ||
      state.step.startsWith('expense_') ||
      state.step === 'waiting_email' ||
      state.step === 'waiting_password'
    )) {
    // ÐžÐ±Ñ€Ð°Ð±Ð°Ñ‚Ñ‹Ð²Ð°ÐµÐ¼ ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ðµ
    if (state.step === 'waiting_email' || state.step === 'waiting_password') {
      await handleMessage(ctx);
    } else {
      await handleGoodState(ctx);
    }
    return;
  }
  
  // ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° ÐºÐ½Ð¾Ð¿Ð¾Ðº Ð¼ÐµÐ½ÑŽ
  switch (text) {
    case 'ðŸ“¦ Ð¡Ð¿Ð¸ÑÐ¾Ðº Ñ‚Ð¾Ð²Ð°Ñ€Ð¾Ð²':
      await handleGoodsList(ctx);
      break;
    case 'âš™ï¸ Ð£Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ Ñ‚Ð¾Ð²Ð°Ñ€Ð°Ð¼Ð¸':
      await handleGoodsMenu(ctx);
      break;
    case 'âž• ÐŸÑ€Ð¸Ñ…Ð¾Ð´':
      await handleIncome(ctx);
      break;
    case 'âž– Ð Ð°ÑÑ…Ð¾Ð´':
      await handleExpense(ctx);
      break;
    case 'ðŸšª Ð’Ñ‹Ð¹Ñ‚Ð¸':
      await handleLogout(ctx);
      break;
    case 'âž• Ð”Ð¾Ð±Ð°Ð²Ð¸Ñ‚ÑŒ Ñ‚Ð¾Ð²Ð°Ñ€':
      await handleCreateGood(ctx);
      break;
    case 'âœï¸ Ð ÐµÐ´Ð°ÐºÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ Ñ‚Ð¾Ð²Ð°Ñ€':
      await handleUpdateGood(ctx);
      break;
    case 'ðŸ—‘ï¸ Ð£Ð´Ð°Ð»Ð¸Ñ‚ÑŒ Ñ‚Ð¾Ð²Ð°Ñ€':
      await handleDeleteGood(ctx);
      break;
    case 'ðŸ“‹ Ð¡Ð¿Ð¸ÑÐ¾Ðº Ñ‚Ð¾Ð²Ð°Ñ€Ð¾Ð²':
      await handleGoodsList(ctx);
      break;
    case 'ðŸ”™ Ð“Ð»Ð°Ð²Ð½Ð¾Ðµ Ð¼ÐµÐ½ÑŽ':
      await ctx.reply('Ð“Ð»Ð°Ð²Ð½Ð¾Ðµ Ð¼ÐµÐ½ÑŽ:', showMainMenu());
      break;
    case 'âž• ÐŸÑ€Ð¸Ñ…Ð¾Ð´ Ñ‚Ð¾Ð²Ð°Ñ€Ð°':
      await handleIncome(ctx);
      break;
    case 'âž– Ð Ð°ÑÑ…Ð¾Ð´ Ñ‚Ð¾Ð²Ð°Ñ€Ð°':
      await handleExpense(ctx);
      break;
    default:
      await ctx.reply('ÐÐµÐ¸Ð·Ð²ÐµÑÑ‚Ð½Ð°Ñ ÐºÐ¾Ð¼Ð°Ð½Ð´Ð°. Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹Ñ‚Ðµ Ð¼ÐµÐ½ÑŽ.');
  }
});

// ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° Ð¾ÑˆÐ¸Ð±Ð¾Ðº
bot.catch((err, ctx) => {
  console.error(`ÐžÑˆÐ¸Ð±ÐºÐ° Ð´Ð»Ñ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ ${ctx.from.id}:`, err);
  ctx.reply('ÐŸÑ€Ð¾Ð¸Ð·Ð¾ÑˆÐ»Ð° Ð¾ÑˆÐ¸Ð±ÐºÐ°. ÐŸÐ¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹Ñ‚Ðµ Ð¿Ð¾Ð·Ð¶Ðµ.');
});

// Ð—Ð°Ð¿ÑƒÑÐº Ð±Ð¾Ñ‚Ð°
console.log('ðŸ¤– Ð‘Ð¾Ñ‚ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½...');
bot.launch();

// Graceful stop
process.once('SIGINT', () => bot.stop('SIGINT'));
process.once('SIGTERM', () => bot.stop('SIGTERM'));

